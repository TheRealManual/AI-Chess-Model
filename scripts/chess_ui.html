<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess AI Playground</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 1.8rem;
            color: #fff;
            margin-bottom: 4px;
        }

        header p {
            color: #888;
            font-size: 0.9rem;
        }

        .game-container {
            display: flex;
            gap: 24px;
            padding: 0 20px 40px;
            max-width: 900px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .board-wrapper {
            width: 480px;
            max-width: 100%;
        }

        #board { width: 100%; }

        .sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .panel {
            background: #16213e;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid #0f3460;
        }

        .panel h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-row {
            display: flex;
            gap: 8px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.15s;
        }

        button:hover { transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        .btn-primary {
            background: #e94560;
            color: #fff;
            flex: 1;
        }
        .btn-primary:hover { background: #d63851; }

        .btn-secondary {
            background: #0f3460;
            color: #e0e0e0;
            flex: 1;
        }
        .btn-secondary:hover { background: #1a4a7a; }
        .btn-secondary.active {
            background: #e94560;
            color: #fff;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            background: #0f3460;
            color: #e0e0e0;
            border: 1px solid #1a4a7a;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .status-bar {
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            border-radius: 6px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .status-bar.thinking { background: #1a4a7a; color: #90caf9; }
        .status-bar.your-turn { background: #1b5e20; color: #a5d6a7; }
        .status-bar.game-over { background: #4a148c; color: #ce93d8; }
        .status-bar.error { background: #b71c1c; color: #ef9a9a; }

        .spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .eval-bar-container {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 6px;
        }

        .eval-bar {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .eval-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
            margin-top: 4px;
        }

        .move-history {
            max-height: 260px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            padding: 4px;
        }

        .move-history::-webkit-scrollbar { width: 6px; }
        .move-history::-webkit-scrollbar-track { background: transparent; }
        .move-history::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .move-pair {
            display: flex;
            gap: 6px;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .move-pair:nth-child(even) { background: rgba(255,255,255,0.03); }

        .move-number { color: #555; min-width: 28px; text-align: right; }
        .move-white, .move-black { min-width: 55px; }
        .move-white { color: #e0e0e0; }
        .move-black { color: #aaa; }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.82rem;
        }
        .info-label { color: #888; }
        .info-value { color: #e0e0e0; font-weight: 500; }

        @media (max-width: 800px) {
            .board-wrapper { width: 100%; }
            .sidebar { width: 100%; }
        }
    </style>
</head>
<body>

<header>
    <h1>Chess AI Playground</h1>
    <p>Play against the self-play trained neural network</p>
</header>

<div class="game-container">
    <div class="board-wrapper">
        <div id="board"></div>
        <div id="status" class="status-bar your-turn">Your turn ΓÇö play as White</div>
    </div>

    <div class="sidebar">
        <div class="panel">
            <h3>Game Controls</h3>
            <div class="controls">
                <div class="btn-row">
                    <button class="btn-primary" onclick="newGame()">New Game</button>
                    <button class="btn-secondary" onclick="undoMove()">Undo</button>
                </div>
                <div class="btn-row">
                    <button id="btn-white" class="btn-secondary active" onclick="playAs('white')">Play White</button>
                    <button id="btn-black" class="btn-secondary" onclick="playAs('black')">Play Black</button>
                </div>
                <div>
                    <label style="font-size:0.8rem; color:#888;">AI Difficulty</label>
                    <select id="difficulty">
                        <option value="easy">Easy (50 sims)</option>
                        <option value="medium" selected>Medium (200 sims)</option>
                        <option value="hard">Hard (400 sims)</option>
                        <option value="max">Max (800 sims)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>Evaluation</h3>
            <div class="eval-bar-container">
                <div id="eval-bar" class="eval-bar" style="width: 50%"></div>
            </div>
            <div class="eval-label">
                <span>Black</span>
                <span id="eval-value">0.00</span>
                <span>White</span>
            </div>
            <div style="margin-top: 10px;">
                <div class="info-row">
                    <span class="info-label">Confidence</span>
                    <span id="confidence" class="info-value">ΓÇö</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Think Time</span>
                    <span id="think-time" class="info-value">ΓÇö</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Move #</span>
                    <span id="move-count" class="info-value">0</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>Move History</h3>
            <div id="moves" class="move-history"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
/*  Inline SVG chess pieces ΓÇö wikipedia style, zero external image deps.
    These are the standard SVGs used by chessboard.js / lichess.       */
const PIECE_SVGS = {
    wK: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 11.63V6M20 8h5" stroke-linejoin="miter"/><path d="M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5" fill="#fff" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z" fill="#fff"/><path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0"/></g></svg>',
    wQ: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="#fff" stroke="#000" stroke-width="1.5" stroke-linejoin="round"><path d="M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zm16.5-4.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM16 8.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM33 9a2 2 0 1 1-4 0 2 2 0 1 1 4 0z"/><path d="M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15L14 11v14L7 14l2 12z" stroke-linecap="butt"/><path d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z" stroke-linecap="butt"/><path d="M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0" fill="none"/></g></svg>',
    wR: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 39h27v-3H9v3zm3-3v-4h21v4H12zm-1-22V9h4v2h5V9h5v2h5V9h4v5" stroke-linecap="butt"/><path d="M34 14l-3 3H14l-3-3"/><path d="M15 17v7h15v-7" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M14 29.5v-13h17v13H14z" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M14 29.5L11 36h23l-3-6.5H14z" stroke-linecap="butt" stroke-linejoin="miter"/></g></svg>',
    wB: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#fff" stroke-linecap="butt"><path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.35.49-2.32.47-3-.5 1.35-1.46 3-2 3-2z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/><path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5" stroke-linejoin="miter"/></g></svg>',
    wN: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21" fill="#fff"/><path d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 3 1 3" fill="#fff"/><path d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zm5.433-9.75a.5 1.5 30 1 1-.866-.5.5 1.5 30 1 1 .866.5z" fill="#000"/></g></svg>',
    wP: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03C15.41 27.09 11 31.58 11 39.5H34c0-7.92-4.41-12.41-7.41-13.47C28.06 24.84 29 23.03 29 21c0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round"/></svg>',
    bK: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 11.63V6" stroke-linejoin="miter"/><path d="M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5" fill="#000" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z" fill="#000"/><path d="M20 8h5" stroke-linejoin="miter"/><path d="M32 29.5s8.5-4 6.03-9.65C34.15 14 25 18 22.5 24.5l.01 2.1-.01-2.1C20 18 9.906 14 6.997 19.85c-2.497 5.65 4.853 9 4.853 9" stroke="#fff"/><path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0" stroke="#fff"/></g></svg>',
    bQ: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#000" stroke="none"><circle cx="6" cy="12" r="2.75"/><circle cx="14" cy="9" r="2.75"/><circle cx="22.5" cy="8" r="2.75"/><circle cx="31" cy="9" r="2.75"/><circle cx="39" cy="12" r="2.75"/></g><path d="M9 26c8.5-1.5 21-1.5 27 0l2.5-12.5L31 25l-.3-14.1-5.2 13.6-3-14.5-3 14.5-5.2-13.6L14 25 6.5 13.5 9 26z" fill="#000" stroke-linecap="butt"/><path d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z" fill="#000" stroke-linecap="butt"/><path d="M11 38.5a35 35 1 0 0 23 0" fill="none" stroke-linecap="butt"/><path d="M11 29a35 35 1 0 1 23 0" fill="none" stroke="#fff"/><path d="M12.5 31.5h20" fill="none" stroke="#fff"/><path d="M11.5 34.5a35 35 1 0 0 22 0" fill="none" stroke="#fff"/><path d="M10.5 37.5a35 35 1 0 0 24 0" fill="none" stroke="#fff"/></g></svg>',
    bR: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 39h27v-3H9v3z" fill="#000" stroke-linecap="butt"/><path d="M12.5 32l1.5-2.5h17l1.5 2.5h-20z" fill="#000" stroke-linecap="butt"/><path d="M12 36v-4h21v4H12z" fill="#000" stroke-linecap="butt"/><path d="M14 29.5v-13h17v13H14z" fill="#000" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M14 16.5L11 14h23l-3 2.5H14z" fill="#000" stroke-linecap="butt"/><path d="M11 14V9h4v2h5V9h5v2h5V9h4v5H11z" fill="#000" stroke-linecap="butt"/><path d="M12 35.5h21m-20-4h19m-18-2h17m-17-13h17M11 14h23" fill="none" stroke="#fff" stroke-width="1" stroke-linejoin="miter"/></g></svg>',
    bB: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#000" stroke-linecap="butt"><path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.35.49-2.32.47-3-.5 1.35-1.46 3-2 3-2z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/><path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5" stroke="#fff" stroke-linejoin="miter"/></g></svg>',
    bN: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21" fill="#000"/><path d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 3 1 3" fill="#000"/><path d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zm5.433-9.75a.5 1.5 30 1 1-.866-.5.5 1.5 30 1 1 .866.5z" fill="#fff" stroke="#fff"/></g></svg>',
    bP: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03C15.41 27.09 11 31.58 11 39.5H34c0-7.92-4.41-12.41-7.41-13.47C28.06 24.84 29 23.03 29 21c0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#000" stroke="#000" stroke-width="1.5" stroke-linecap="round"/></svg>',
};

// Convert SVG strings to data-URI for chessboard.js pieceTheme
function pieceTheme(piece) {
    if (PIECE_SVGS[piece]) {
        return 'data:image/svg+xml,' + encodeURIComponent(PIECE_SVGS[piece]);
    }
    return '';
}

// API base URL ΓÇö same origin when served from FastAPI, fallback for file://
const API_BASE = (window.location.protocol === 'file:')
    ? 'http://localhost:8000'
    : window.location.origin;

let board = null;
let game = new Chess();
let playerColor = 'white';
let aiThinking = false;

// --- UI helpers ---

function setStatus(text, type) {
    const el = document.getElementById('status');
    el.className = 'status-bar ' + type;
    if (type === 'thinking') {
        el.innerHTML = '<span class="spinner"></span> ' + text;
    } else {
        el.textContent = text;
    }
}

function updateEval(value, confidence, thinkTime) {
    const pct = Math.max(2, Math.min(98, (value + 1) / 2 * 100));
    document.getElementById('eval-bar').style.width = pct + '%';
    document.getElementById('eval-value').textContent = value.toFixed(2);
    document.getElementById('confidence').textContent =
        confidence != null ? (confidence * 100).toFixed(0) + '%' : '\u2014';
    document.getElementById('think-time').textContent =
        thinkTime != null ? thinkTime.toFixed(0) + 'ms' : '\u2014';
}

function updateMoveDisplay() {
    const moves = game.history();
    document.getElementById('move-count').textContent = Math.ceil(moves.length / 2);

    let html = '';
    for (let i = 0; i < moves.length; i += 2) {
        const num = Math.floor(i / 2) + 1;
        const w = moves[i] || '';
        const b = moves[i + 1] || '';
        html += '<div class="move-pair">' +
            '<span class="move-number">' + num + '.</span>' +
            '<span class="move-white">' + w + '</span>' +
            '<span class="move-black">' + b + '</span></div>';
    }
    const box = document.getElementById('moves');
    box.innerHTML = html;
    box.scrollTop = box.scrollHeight;
}

function checkGameOver() {
    if (!game.game_over()) return false;
    let msg;
    if (game.in_checkmate()) {
        msg = 'Checkmate! ' + (game.turn() === 'w' ? 'Black' : 'White') + ' wins!';
    } else if (game.in_stalemate()) {
        msg = 'Stalemate \u2014 Draw';
    } else if (game.in_threefold_repetition()) {
        msg = 'Threefold repetition \u2014 Draw';
    } else if (game.insufficient_material()) {
        msg = 'Insufficient material \u2014 Draw';
    } else if (game.in_draw()) {
        msg = 'Draw by 50-move rule';
    } else {
        msg = 'Game over';
    }
    setStatus(msg, 'game-over');
    return true;
}

// --- AI move ---

async function makeAIMove() {
    if (game.game_over() || aiThinking) return;
    aiThinking = true;
    setStatus('AI is thinking\u2026', 'thinking');

    const difficulty = document.getElementById('difficulty').value;

    try {
        const resp = await fetch(API_BASE + '/api/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fen: game.fen(), difficulty: difficulty }),
        });
        if (!resp.ok) throw new Error('API returned ' + resp.status);
        const data = await resp.json();

        // Parse UCI move (e.g. "e2e4", "e7e8q")
        const from = data.move.substring(0, 2);
        const to   = data.move.substring(2, 4);
        const moveObj = { from: from, to: to };
        if (data.move.length > 4) moveObj.promotion = data.move[4];

        const result = game.move(moveObj);
        if (result) {
            board.position(game.fen(), false);   // false = no animation glitch
            updateMoveDisplay();

            // eval from AI perspective ΓÇö flip for white-relative display
            let ev = data.value || 0;
            if (playerColor === 'white') ev = -ev;
            updateEval(ev, data.confidence || null, data.think_time_ms || null);

            if (!checkGameOver()) {
                setStatus('Your turn', 'your-turn');
            }
        } else {
            console.error('Invalid AI move:', data.move, 'for FEN:', game.fen());
            setStatus('AI returned invalid move: ' + data.move, 'error');
        }
    } catch (err) {
        console.error('API error:', err);
        setStatus('Cannot reach AI server \u2014 is it running on port 8000?', 'error');
    }
    aiThinking = false;
}

// --- Board callbacks ---

function onDragStart(source, piece) {
    if (game.game_over() || aiThinking) return false;
    if (playerColor === 'white' && piece.search(/^b/) !== -1) return false;
    if (playerColor === 'black' && piece.search(/^w/) !== -1) return false;
    if (playerColor === 'white' && game.turn() !== 'w') return false;
    if (playerColor === 'black' && game.turn() !== 'b') return false;
    return true;
}

function onDrop(source, target) {
    const move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) return 'snapback';

    updateMoveDisplay();
    if (!checkGameOver()) {
        setTimeout(makeAIMove, 100);
    }
}

function onSnapEnd() {
    board.position(game.fen(), false);
}

// --- Controls ---

function newGame() {
    game = new Chess();
    board.orientation(playerColor);
    board.position('start', false);
    updateMoveDisplay();
    updateEval(0, null, null);
    aiThinking = false;
    setStatus('Your turn \u2014 play as ' + (playerColor === 'white' ? 'White' : 'Black'), 'your-turn');
    if (playerColor === 'black') {
        setTimeout(makeAIMove, 300);
    }
}

function playAs(color) {
    playerColor = color;
    document.getElementById('btn-white').classList.toggle('active', color === 'white');
    document.getElementById('btn-black').classList.toggle('active', color === 'black');
    newGame();
}

function undoMove() {
    if (aiThinking) return;
    game.undo();   // undo AI move
    game.undo();   // undo player move
    board.position(game.fen(), false);
    updateMoveDisplay();
    setStatus('Your turn', 'your-turn');
}

// --- Init ---
board = Chessboard('board', {
    draggable: true,
    position: 'start',
    orientation: 'white',
    onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd,
    pieceTheme: pieceTheme,
    appearSpeed: 0,
    moveSpeed: 0,
    snapSpeed: 0,
});

setStatus('Your turn \u2014 play as White', 'your-turn');

$(window).resize(function() { board.resize(); });
</script>
</body>
</html>
